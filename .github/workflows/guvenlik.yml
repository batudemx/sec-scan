name: DevSecOps CI/CD Pipeline 

on:
  push:
    branches: [ "main" ]

jobs:
  # CI sÃ¼reci
  build-and-push:
    name: Build, Scan & Push
    runs-on: ubuntu-latest
    
    steps:
      - name: Kodu Getir
        uses: actions/checkout@v3

      - name: Docker Hub'a GiriÅŸ Yap
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Build (Etiketle)
        # Ä°majÄ± hem 'latest' hem de 'commit-id' ile etiketliyoruz
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/devsecops-proje:latest .

      - name: Trivy GÃ¼venlik TaramasÄ± ğŸ›¡ï¸
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/devsecops-proje:latest'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL'

      - name: Docker Hub'a YÃ¼kle (Push)
        # EÄŸer tarama temiz Ã§Ä±karsa, imajÄ± depoya gÃ¶nder
        run: docker push ${{ secrets.DOCKER_USERNAME }}/devsecops-proje:latest

  # CD sÃ¼reci
  deploy:
    name: EC2 Sunucusuna DaÄŸÄ±t
    needs: build-and-push # Ä°lk gÃ¶rev bitmeden bu baÅŸlamaz
    runs-on: ubuntu-latest

    steps:
      - name: SSH ile Sunucuya BaÄŸlan ve GÃ¼ncelle
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Yeni imajÄ± Ã§ek
            docker pull ${{ secrets.DOCKER_USERNAME }}/devsecops-proje:latest
            
            # 2. Eski konteyneri durdur ve sil (Varsa)
            docker rm -f guvenlik-uygulamasi || true
            
            # 3. Yeni konteyneri baÅŸlat (Port 80'den yayÄ±nla)
            docker run -d -p 80:8501 --name guvenlik-uygulamasi --restart unless-stopped ${{ secrets.DOCKER_USERNAME }}/devsecops-proje:latest
            
            # 4. Gereksiz (eski) imajlarÄ± temizle
            docker image prune -f